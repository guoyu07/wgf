// Copyright 2014 The Wgf Authors. All rights reserved.
// Use of this source code is governed by a MIT
// license that can be found in the LICENSE file.

package wgf

import (
	"fmt"
	"flag"
	"os"

	//load sapi module
	"wgf/lib/conf"
	"wgf/sapi"

	//for test only.
	//"runtime/pprof"

	//load all core plugins
	_ "wgf/plugin/cookie"
	_ "wgf/plugin/header"
	_ "wgf/plugin/httpparam"
	_ "wgf/plugin/router"
	_ "wgf/plugin/session"
	_ "wgf/plugin/view"
)

const (
	Version = "0.1"
)

var basedir *string
var conffile *string

//set the main flags for all kinds of servers
func setMainFlags() {
	basedir	 = flag.String("basedir", "", "set the basedir, the `pwd` is default")
	conffile = flag.String("conf", "wgf.ini", "set the default filename located in $basedir/conf/, wgf.ini is the default")
}

func parseArgs() {
	if flag.Parsed() {
		return
	}

	setMainFlags()
	flag.Usage = printHelpInfo
	flag.Parse()

	if "" == *basedir {
		var err error
		*basedir, err = os.Getwd()
		if nil != err {
			fmt.Println("error occurs when getting pwd:", err)
			os.Exit(-1)
		}
	}

	if "" == *conffile {
		*conffile = "wgf.ini"
	}
}

func printHelpInfo() {
	fmt.Fprintf(os.Stderr, "wgf is a framework written in go.\n")
	fmt.Fprintf(os.Stderr, "version: %s\n", Version)
	fmt.Fprintf(os.Stderr, "\n")
	flag.PrintDefaults()
	fmt.Fprintf(os.Stderr, "\n")
}

func initConf() *conf.Conf {
	var confFile string
	var pConf *conf.Conf
	var err error

	pConf = conf.NewConf()
	confFile = *basedir + "/conf/" + *conffile
	err = pConf.ParseFile(confFile)
	if nil != err {
		fmt.Fprintln(os.Stderr, err)
		os.Exit(-1)
	}
	return pConf
}

//启动Http服务器
func StartHttpServer() {
	parseArgs()
	pServer := sapi.NewServer()
	pServer.Boot(*basedir, initConf())
}

//启动Websocket服务器
func StartWebSocketServer() {
	parseArgs()
	pServer := sapi.NewWebsocketServer()
	pServer.Boot(*basedir, initConf())
}

//启动Cli终端程序
func StartCliServer() {
	//set flags for cli
	var action *string
	action	 = flag.String("a", "index", "set the action name, index is default")

	parseArgs()

	pServer := sapi.NewCliServer()
	pServer.Handler.(*sapi.CliServerHandler).SetActionName(*action)

	pServer.Boot(*basedir, initConf())
}

//启动Socket服务: tcp or unixsocket
func StartSocketServer() {
	parseArgs()
	pServer := sapi.NewSocketServer()
	pServer.Boot(*basedir, initConf())
}

func StartServerEx(creator func()*sapi.Server) {
	parseArgs()
	pServer := creator()
	pServer.Boot(*basedir, initConf())
}
